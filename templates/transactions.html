{% extends "base.html" %}
{% block title %}ê±°ë˜ë‚´ì—­ - ê°€ê³„ë¶€{% endblock %}

{% block content %}
<div class="transactions-page">
    <header class="page-header">
        <h1>ğŸ“‹ ê±°ë˜ ë‚´ì—­</h1>
        {% if current_year and current_month %}
        <div class="tx-count-badge">{{ current_year }}ë…„ {{ current_month }}ì›” ê±°ë˜: <strong>{{ transactions|length
                }}ê±´</strong></div>
        {% else %}
        <div class="tx-count-badge">ì „ì²´ ê±°ë˜: <strong>{{ transactions|length }}ê±´</strong></div>
        {% endif %}
    </header>

    <div class="filters card">
        <form method="GET" class="filter-form">
            <select name="year" onchange="this.form.submit()">
                <option value="">ì „ì²´ ì—°ë„</option>
                {% for y in years %}
                <option value="{{ y }}" {% if y==current_year %}selected{% endif %}>{{ y }}ë…„</option>
                {% endfor %}
            </select>

            <select name="month" onchange="this.form.submit()">
                <option value="">ì „ì²´ ì›”</option>
                {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m==current_month %}selected{% endif %}>{{ m }}ì›”</option>
                {% endfor %}
            </select>

            <select name="category" onchange="this.form.submit()">
                <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if cat.id==current_category %}selected{% endif %}>{{ cat.name }}
                </option>
                {% endfor %}
            </select>

            <select name="tag" onchange="this.form.submit()">
                <option value="">ì „ì²´ íƒœê·¸</option>
                {% for tag in tags %}
                <option value="{{ tag.id }}" {% if tag.id==current_tag %}selected{% endif %}>#{{ tag.name }}</option>
                {% endfor %}
            </select>

            <input type="text" name="search" placeholder="ê°€ë§¹ì  ê²€ìƒ‰..." value="{{ search }}" class="search-input">
            <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
        </form>
    </div>

    <div class="card">
        <table class="tx-table" id="txTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="date">ë‚ ì§œ â‡…</th>
                    <th class="sortable" data-sort="merchant">ê°€ë§¹ì  â‡…</th>
                    <th>ì—…ì¢…</th>
                    <th class="sortable" data-sort="amount">ê¸ˆì•¡ â‡…</th>
                    <th>ì¹´í…Œê³ ë¦¬</th>
                    <th>ë©”ëª¨</th>
                    <th>íƒœê·¸</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr data-id="{{ tx.id }}">
                    <td class="date">{{ tx.date[:4] }}.{{ tx.date[4:6] }}.{{ tx.date[6:8] }}</td>
                    <td class="merchant">
                        {{ tx.merchant }}
                        {% if tx.is_overseas %}<span class="badge overseas">í•´ì™¸</span>{% endif %}
                    </td>
                    <td class="business-type">{{ tx.business_type or '-' }}</td>
                    <td class="amount">â‚©{{ "{:,}".format(tx.billed_amount) }}</td>
                    <td class="category">
                        <select class="category-select" data-tx-id="{{ tx.id }}" data-merchant="{{ tx.merchant }}">
                            <option value="">ë¯¸ë¶„ë¥˜</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if cat.id==tx.category_id %}selected{% endif %}>{{ cat.name
                                }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="memo">
                        <input type="text" class="memo-input" data-tx-id="{{ tx.id }}" value="{{ tx.memo or '' }}"
                            placeholder="ë©”ëª¨ ì¶”ê°€...">
                    </td>
                    <td class="tags">
                        <div class="tag-list">
                            {% for tag in tx.tags %}
                            <span class="tag" style="background: {{ tag.color }}">
                                #{{ tag.name }}
                                <button class="tag-remove" data-tx-id="{{ tx.id }}"
                                    data-tag-id="{{ tag.id }}">Ã—</button>
                            </span>
                            {% endfor %}
                            <input type="text" class="tag-input" data-tx-id="{{ tx.id }}" placeholder="+ íƒœê·¸">
                        </div>
                    </td>
                    <td class="actions">
                        <button class="btn btn-icon btn-delete" data-tx-id="{{ tx.id }}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="empty-msg">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ì¹´í…Œê³ ë¦¬ ë³€ê²½
    document.querySelectorAll('.category-select').forEach(select => {
        select.addEventListener('change', async (e) => {
            const txId = e.target.dataset.txId;
            const categoryId = e.target.value || null;
            const merchant = e.target.dataset.merchant;

            await fetch(`/api/transactions/${txId}/category`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category_id: categoryId ? parseInt(categoryId) : null,
                    merchant: merchant,
                    save_rule: true
                })
            });
            showToast('ì¹´í…Œê³ ë¦¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        });
    });

    // ë©”ëª¨ ì €ì¥ (blur ì‹œ)
    document.querySelectorAll('.memo-input').forEach(input => {
        input.addEventListener('blur', async (e) => {
            const txId = e.target.dataset.txId;
            const content = e.target.value;

            await fetch(`/api/transactions/${txId}/memo`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
        });
    });

    // íƒœê·¸ ì¶”ê°€
    document.querySelectorAll('.tag-input').forEach(input => {
        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const txId = e.target.dataset.txId;
                const name = e.target.value.trim().replace(/^#/, '');

                if (name) {
                    const res = await fetch(`/api/transactions/${txId}/tags`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });

                    if (res.ok) {
                        location.reload();
                    }
                }
            }
        });
    });

    // íƒœê·¸ ì‚­ì œ
    document.querySelectorAll('.tag-remove').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const txId = e.target.dataset.txId;
            const tagId = e.target.dataset.tagId;

            await fetch(`/api/transactions/${txId}/tags`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tag_id: parseInt(tagId) })
            });

            e.target.parentElement.remove();
        });
    });

    // ê±°ë˜ ì‚­ì œ
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            if (!confirm('ì´ ê±°ë˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const txId = e.target.dataset.txId;
            await fetch(`/api/transactions/${txId}`, { method: 'DELETE' });
            e.target.closest('tr').remove();
            showToast('ê±°ë˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        });
    });

    // í…Œì´ë¸” ì •ë ¬
    let sortOrder = {};
    document.querySelectorAll('.sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
            const sortKey = th.dataset.sort;
            const table = document.getElementById('txTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // ì •ë ¬ ìˆœì„œ í† ê¸€
            sortOrder[sortKey] = !sortOrder[sortKey];
            const ascending = sortOrder[sortKey];

            rows.sort((a, b) => {
                let aVal, bVal;

                if (sortKey === 'date') {
                    aVal = a.querySelector('.date')?.textContent || '';
                    bVal = b.querySelector('.date')?.textContent || '';
                } else if (sortKey === 'merchant') {
                    aVal = a.querySelector('.merchant')?.textContent?.trim() || '';
                    bVal = b.querySelector('.merchant')?.textContent?.trim() || '';
                } else if (sortKey === 'amount') {
                    aVal = parseInt(a.querySelector('.amount')?.textContent?.replace(/[^\d]/g, '') || 0);
                    bVal = parseInt(b.querySelector('.amount')?.textContent?.replace(/[^\d]/g, '') || 0);
                    return ascending ? aVal - bVal : bVal - aVal;
                }

                return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });
</script>
{% endblock %}