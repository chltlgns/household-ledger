{% extends "base.html" %}
{% block title %}ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ - ê°€ê³„ë¶€{% endblock %}

{% block content %}
<div class="categories-page">
    <header class="page-header">
        <h1>ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h1>
    </header>

    <!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€ -->
    <div class="card">
        <h2>ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h2>
        <form id="addCategoryForm" class="add-form">
            <input type="text" name="name" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„" required>
            <input type="color" name="color" value="#6366f1">
            <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        </form>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ ëª©ë¡ -->
    <div class="card">
        <h2>ì¹´í…Œê³ ë¦¬ ëª©ë¡</h2>
        <ul class="category-list" id="categoryList">
            {% for cat in categories %}
            <li class="category-item" data-id="{{ cat.id }}">
                <span class="color-dot" style="background: {{ cat.color }}"></span>
                <span class="category-name">{{ cat.name }}</span>
                <div class="category-actions">
                    <input type="color" class="color-picker" value="{{ cat.color }}" data-id="{{ cat.id }}">
                    <button class="btn btn-icon btn-edit" data-id="{{ cat.id }}" title="ìˆ˜ì •">âœï¸</button>
                    <button class="btn btn-icon btn-delete" data-id="{{ cat.id }}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                </div>
            </li>
            {% else %}
            <li class="empty-msg">ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</li>
            {% endfor %}
        </ul>
    </div>

    <!-- ìƒˆë¡œìš´ ê°€ë§¹ì  (ë¯¸ë¶„ë¥˜) -->
    <div class="card">
        <h2>ğŸ†• ìƒˆë¡œìš´ ê°€ë§¹ì  <span class="count-badge">{{ uncategorized_merchants|length }}</span></h2>
        <p class="help-text">ì•„ë˜ ê°€ë§¹ì ì— ì¹´í…Œê³ ë¦¬ë¥¼ ì§€ì •í•˜ë©´ í•´ë‹¹ ê°€ë§¹ì ì˜ ëª¨ë“  ê±°ë˜ì— ìë™ ì ìš©ë©ë‹ˆë‹¤.</p>

        <!-- Bulk Action Bar for Uncategorized -->
        <div class="bulk-action-bar" id="uncategorizedBulkBar">
            <span class="selected-count"><span id="uncategorizedSelectedCount">0</span>ê±´ ì„ íƒë¨</span>
            <select id="uncategorizedBulkCategory">
                <option value="">ì¹´í…Œê³ ë¦¬ ì¼ê´„ ì ìš©</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <button class="btn" id="uncategorizedBulkApply">ì ìš©</button>
            <button class="btn" id="uncategorizedClearSelection">ì„ íƒ í•´ì œ</button>
        </div>

        {% if uncategorized_merchants %}
        <ul class="merchant-list" id="uncategorizedList">
            {% for m in uncategorized_merchants %}
            <li class="merchant-item" data-merchant="{{ m.merchant }}">
                <div class="row-checkbox" data-merchant="{{ m.merchant }}"></div>
                <div class="merchant-info">
                    <span class="merchant-name">{{ m.merchant }}</span>
                    <span class="merchant-meta">{{ m.business_type or '' }} Â· {{ m.tx_count }}ê±´</span>
                </div>
                <select class="merchant-category-select" data-merchant="{{ m.merchant }}">
                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ...</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-msg">ëª¨ë“  ê°€ë§¹ì ì´ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“</p>
        {% endif %}
    </div>

    <!-- ì €ì¥ëœ ê°€ë§¹ì  ê·œì¹™ -->
    <div class="card">
        <h2>âœ… ì €ì¥ëœ ê°€ë§¹ì  <span class="count-badge">{{ merchant_rules|length }}</span></h2>
        <p class="help-text">ì¹´í…Œê³ ë¦¬ê°€ ì§€ì •ëœ ê°€ë§¹ì ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ê±°ë˜ê°€ ì¶”ê°€ë˜ë©´ ìë™ìœ¼ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.</p>

        <!-- Bulk Action Bar for Saved -->
        <div class="bulk-action-bar" id="savedBulkBar">
            <span class="selected-count"><span id="savedSelectedCount">0</span>ê±´ ì„ íƒë¨</span>
            <select id="savedBulkCategory">
                <option value="">ì¹´í…Œê³ ë¦¬ ì¼ê´„ ë³€ê²½</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <button class="btn" id="savedBulkApply">ì ìš©</button>
            <button class="btn btn-danger" id="savedBulkDelete">ê·œì¹™ ì‚­ì œ</button>
            <button class="btn" id="savedClearSelection">ì„ íƒ í•´ì œ</button>
        </div>

        {% if merchant_rules %}
        <ul class="merchant-list saved-merchants" id="savedList">
            {% for rule in merchant_rules %}
            <li class="merchant-item" data-merchant="{{ rule.merchant_pattern }}">
                <div class="row-checkbox" data-merchant="{{ rule.merchant_pattern }}"></div>
                <div class="merchant-info">
                    <span class="merchant-name">{{ rule.merchant_pattern }}</span>
                    <span class="category-badge" style="background: {{ rule.category_color }}">{{ rule.category_name
                        }}</span>
                </div>
                <div class="merchant-actions">
                    <select class="merchant-category-select saved" data-merchant="{{ rule.merchant_pattern }}">
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if cat.id==rule.category_id %}selected{% endif %}>{{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-icon btn-remove-rule" data-merchant="{{ rule.merchant_pattern }}"
                        title="ê·œì¹™ ì œê±°">âŒ</button>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-msg">ì €ì¥ëœ ê°€ë§¹ì  ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ì„ íƒëœ ê°€ë§¹ì  ê´€ë¦¬
    let uncategorizedSelected = new Set();
    let savedSelected = new Set();

    // ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥ - ë¯¸ë¶„ë¥˜ ê°€ë§¹ì 
    document.querySelectorAll('#uncategorizedList .row-checkbox').forEach(cb => {
        cb.addEventListener('click', () => {
            const merchant = cb.dataset.merchant;
            const item = cb.closest('.merchant-item');

            if (cb.classList.contains('checked')) {
                cb.classList.remove('checked');
                item.classList.remove('selected');
                uncategorizedSelected.delete(merchant);
            } else {
                cb.classList.add('checked');
                item.classList.add('selected');
                uncategorizedSelected.add(merchant);
            }
            updateBulkBar('uncategorized', uncategorizedSelected);
        });
    });

    // ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥ - ì €ì¥ëœ ê°€ë§¹ì 
    document.querySelectorAll('#savedList .row-checkbox').forEach(cb => {
        cb.addEventListener('click', () => {
            const merchant = cb.dataset.merchant;
            const item = cb.closest('.merchant-item');

            if (cb.classList.contains('checked')) {
                cb.classList.remove('checked');
                item.classList.remove('selected');
                savedSelected.delete(merchant);
            } else {
                cb.classList.add('checked');
                item.classList.add('selected');
                savedSelected.add(merchant);
            }
            updateBulkBar('saved', savedSelected);
        });
    });

    function updateBulkBar(type, selectedSet) {
        const bar = document.getElementById(type + 'BulkBar');
        const count = document.getElementById(type + 'SelectedCount');
        count.textContent = selectedSet.size;
        bar.classList.toggle('visible', selectedSet.size > 0);
    }

    // ì„ íƒ í•´ì œ
    document.getElementById('uncategorizedClearSelection')?.addEventListener('click', () => {
        document.querySelectorAll('#uncategorizedList .row-checkbox').forEach(cb => {
            cb.classList.remove('checked');
            cb.closest('.merchant-item').classList.remove('selected');
        });
        uncategorizedSelected.clear();
        updateBulkBar('uncategorized', uncategorizedSelected);
    });

    document.getElementById('savedClearSelection')?.addEventListener('click', () => {
        document.querySelectorAll('#savedList .row-checkbox').forEach(cb => {
            cb.classList.remove('checked');
            cb.closest('.merchant-item').classList.remove('selected');
        });
        savedSelected.clear();
        updateBulkBar('saved', savedSelected);
    });

    // ì¼ê´„ ì¹´í…Œê³ ë¦¬ ì ìš© (ë¯¸ë¶„ë¥˜)
    document.getElementById('uncategorizedBulkApply')?.addEventListener('click', async () => {
        const categoryId = document.getElementById('uncategorizedBulkCategory').value;
        if (!categoryId) {
            showToast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
            return;
        }
        if (uncategorizedSelected.size === 0) return;

        for (const merchant of uncategorizedSelected) {
            await fetch('/api/merchants/rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ merchant, category_id: parseInt(categoryId) })
            });
        }
        showToast(`${uncategorizedSelected.size}ê°œ ê°€ë§¹ì ì— ì¹´í…Œê³ ë¦¬ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤`);
        location.reload();
    });

    // ì¼ê´„ ì¹´í…Œê³ ë¦¬ ë³€ê²½ (ì €ì¥ëœ)
    document.getElementById('savedBulkApply')?.addEventListener('click', async () => {
        const categoryId = document.getElementById('savedBulkCategory').value;
        if (!categoryId) {
            showToast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
            return;
        }
        if (savedSelected.size === 0) return;

        for (const merchant of savedSelected) {
            await fetch('/api/merchants/rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ merchant, category_id: parseInt(categoryId) })
            });
        }
        showToast(`${savedSelected.size}ê°œ ê°€ë§¹ì ì˜ ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
        location.reload();
    });

    // ì¼ê´„ ê·œì¹™ ì‚­ì œ
    document.getElementById('savedBulkDelete')?.addEventListener('click', async () => {
        if (savedSelected.size === 0) return;
        if (!confirm(`${savedSelected.size}ê°œì˜ ë¶„ë¥˜ ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        for (const merchant of savedSelected) {
            await fetch('/api/merchants/rule', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ merchant })
            });
        }
        showToast(`${savedSelected.size}ê°œì˜ ê·œì¹™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
        location.reload();
    });

    // ì¹´í…Œê³ ë¦¬ ì¶”ê°€
    document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        const res = await fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: formData.get('name'),
                color: formData.get('color')
            })
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    });

    // ìƒ‰ìƒ ë³€ê²½
    document.querySelectorAll('.color-picker').forEach(picker => {
        picker.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            await fetch(`/api/categories/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ color: e.target.value })
            });
            e.target.closest('.category-item').querySelector('.color-dot').style.background = e.target.value;
            showToast('ìƒ‰ìƒì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
        });
    });

    // ì¹´í…Œê³ ë¦¬ ìˆ˜ì •
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const li = e.target.closest('li');
            const nameSpan = li.querySelector('.category-name');
            const currentName = nameSpan.textContent;

            const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentName);
            if (newName && newName !== currentName) {
                await fetch(`/api/categories/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                nameSpan.textContent = newName;
                showToast('ì¹´í…Œê³ ë¦¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        });
    });

    // ì¹´í…Œê³ ë¦¬ ì‚­ì œ
    document.querySelectorAll('.category-list .btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            if (!confirm('ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ê±°ë˜ë“¤ì€ ë¯¸ë¶„ë¥˜ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) return;

            const id = e.target.dataset.id;
            await fetch(`/api/categories/${id}`, { method: 'DELETE' });
            e.target.closest('li').remove();
            showToast('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        });
    });

    // ê°€ë§¹ì  ì¹´í…Œê³ ë¦¬ ì§€ì • (ìƒˆë¡œìš´ ê°€ë§¹ì  - ê°œë³„)
    document.querySelectorAll('.merchant-category-select:not(.saved)').forEach(select => {
        select.addEventListener('change', async (e) => {
            const merchant = e.target.dataset.merchant;
            const categoryId = e.target.value;

            if (!categoryId) return;

            const res = await fetch('/api/merchants/rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ merchant, category_id: parseInt(categoryId) })
            });

            if (res.ok) {
                const data = await res.json();
                showToast(`${merchant}ì˜ ì¹´í…Œê³ ë¦¬ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤ (${data.affected}ê±´ ì ìš©)`);
                location.reload();
            } else {
                const data = await res.json();
                showToast(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        });
    });

    // ì €ì¥ëœ ê°€ë§¹ì  ì¹´í…Œê³ ë¦¬ ë³€ê²½ (ê°œë³„)
    document.querySelectorAll('.merchant-category-select.saved').forEach(select => {
        select.addEventListener('change', async (e) => {
            const merchant = e.target.dataset.merchant;
            const categoryId = e.target.value;

            const res = await fetch('/api/merchants/rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ merchant, category_id: parseInt(categoryId) })
            });

            if (res.ok) {
                const data = await res.json();
                showToast(`ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤ (${data.affected}ê±´ ì ìš©)`);
                location.reload();
            }
        });
    });

    // ê°€ë§¹ì  ê·œì¹™ ì œê±° (ê°œë³„)
    document.querySelectorAll('.btn-remove-rule').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const merchant = e.target.dataset.merchant;
            if (!confirm(`${merchant}ì˜ ë¶„ë¥˜ ê·œì¹™ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            await fetch('/api/merchants/rule', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ merchant })
            });

            showToast('ê·œì¹™ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
            location.reload();
        });
    });
</script>
{% endblock %}