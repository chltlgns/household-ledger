{% extends "base.html" %}
{% block title %}ë¶„ì„ ë¦¬í¬íŠ¸ - ê°€ê³„ë¶€{% endblock %}

{% block content %}
<div class="reports-page">
    <header class="page-header">
        <h1>ğŸ“ˆ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
        <div class="date-nav">
            <select id="yearSelect" onchange="updateReport()">
                {% for y in years %}
                <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}ë…„</option>
                {% endfor %}
            </select>
            <select id="monthSelect" onchange="updateReport()">
                {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}ì›”</option>
                {% endfor %}
            </select>
        </div>
    </header>

    <!-- 1. ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ -->
    <section class="card report-section">
        <h2>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h2>
        <div id="categoryChart" class="chart-container"></div>
        <div class="summary-list">
            {% for s in category_summary %}
            <div class="summary-item">
                <span class="color-dot" style="background: {{ s.color or '#64748b' }}"></span>
                <span class="name">{{ s.name or 'ë¯¸ë¶„ë¥˜' }}</span>
                <span class="count">{{ s.count or 0 }}ê±´</span>
                <span class="total">â‚©{{ "{:,}".format(s.total or 0) }}</span>
            </div>
            {% else %}
            <p class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            {% endfor %}
        </div>
    </section>

    <!-- 2. ì§€ì¶œ ë¹„êµ (ì´ë²ˆë‹¬ vs ì „ë‹¬) -->
    <section class="card report-section">
        <h2>ğŸ“‰ ì§€ì¶œ ë¹„êµ <span class="compare-period">{{ year }}ë…„ {{ month }}ì›” vs {{ prev_year }}ë…„ {{ prev_month }}ì›”</span>
        </h2>

        <!-- ì´ ì§€ì¶œ ë¹„êµ -->
        <div class="total-comparison">
            <div class="compare-card current">
                <div class="compare-label">ì´ë²ˆë‹¬</div>
                <div class="compare-value">â‚©{{ "{:,}".format(current_total) }}</div>
            </div>
            <div class="compare-card diff {% if total_diff > 0 %}increase{% else %}decrease{% endif %}">
                <div class="compare-label">ì°¨ì´</div>
                <div class="compare-value">
                    {% if total_diff > 0 %}+{% endif %}â‚©{{ "{:,}".format(total_diff) }}
                    <span class="percent">({% if total_diff_percent > 0 %}+{% endif %}{{
                        "%.1f"|format(total_diff_percent) }}%)</span>
                </div>
            </div>
            <div class="compare-card prev">
                <div class="compare-label">ì „ë‹¬</div>
                <div class="compare-value">â‚©{{ "{:,}".format(prev_total) }}</div>
            </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ ë¹„êµ ì°¨íŠ¸ -->
        <div id="comparisonChart" class="chart-container"></div>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ ë¹„êµ ë¦¬ìŠ¤íŠ¸ -->
        <div class="comparison-list">
            {% for item in comparison_data %}
            <div class="comparison-item">
                <span class="color-dot" style="background: {{ item.color }}"></span>
                <span class="name">{{ item.name }}</span>
                <span class="current">â‚©{{ "{:,}".format(item.current) }}</span>
                <span class="diff {% if item.current - item.prev > 0 %}increase{% else %}decrease{% endif %}">
                    {% if item.current - item.prev > 0 %}â–²{% elif item.current - item.prev < 0 %}â–¼{% else %}-{% endif %}
                        â‚©{{ "{:,}" .format((item.current - item.prev)|abs) }} </span>
                        <span class="prev">â‚©{{ "{:,}".format(item.prev) }}</span>
            </div>
            {% else %}
            <p class="empty-msg">ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            {% endfor %}
        </div>
    </section>

    <!-- 3. ì›”ë³„ ì§€ì¶œ ì¶”ì´ -->
    <section class="card report-section">
        <h2>ğŸ“ˆ ì›”ë³„ ì§€ì¶œ ì¶”ì´ ({{ year }}ë…„)</h2>
        <div id="monthlyChart" class="chart-container"></div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    const categoryData = {{ category_summary | tojson }};
    const comparisonData = {{ comparison_data | tojson }};
    const yearlyData = {{ yearly | tojson }};

    // ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸
    if (categoryData.length > 0) {
        Plotly.newPlot('categoryChart', [{
            type: 'bar',
            x: categoryData.map(s => s.name || 'ë¯¸ë¶„ë¥˜'),
            y: categoryData.map(s => s.total || 0),
            marker: {
                color: categoryData.map(s => s.color || '#64748b'),
                borderRadius: 4
            },
            text: categoryData.map(s => 'â‚©' + (s.total || 0).toLocaleString()),
            textposition: 'outside'
        }], {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#e2e8f0', family: 'Pretendard, sans-serif' },
            xaxis: { showgrid: false },
            yaxis: { showgrid: true, gridcolor: '#334155' },
            margin: { t: 30, b: 60, l: 60, r: 30 },
            height: 350
        }, { responsive: true });
    }

    // ë¹„êµ ì°¨íŠ¸
    if (comparisonData.length > 0) {
        const categories = comparisonData.map(d => d.name);
        const currentValues = comparisonData.map(d => d.current);
        const prevValues = comparisonData.map(d => d.prev);

        Plotly.newPlot('comparisonChart', [
            {
                name: 'ì´ë²ˆë‹¬',
                type: 'bar',
                x: categories,
                y: currentValues,
                marker: { color: '#6366f1' }
            },
            {
                name: 'ì „ë‹¬',
                type: 'bar',
                x: categories,
                y: prevValues,
                marker: { color: '#64748b' }
            }
        ], {
            barmode: 'group',
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#e2e8f0', family: 'Pretendard, sans-serif' },
            xaxis: { showgrid: false },
            yaxis: { showgrid: true, gridcolor: '#334155' },
            legend: { orientation: 'h', y: 1.1 },
            margin: { t: 50, b: 60, l: 60, r: 30 },
            height: 350
        }, { responsive: true });
    }

    // ì›”ë³„ ì¶”ì´ ì°¨íŠ¸
    if (yearlyData.length > 0) {
        const months = yearlyData.map(d => d.month + 'ì›”');
        const totals = yearlyData.map(d => d.total || 0);

        Plotly.newPlot('monthlyChart', [{
            type: 'scatter',
            mode: 'lines+markers',
            x: months,
            y: totals,
            line: { color: '#6366f1', width: 3, shape: 'spline' },
            marker: { size: 8, color: '#6366f1' },
            fill: 'tozeroy',
            fillcolor: 'rgba(99, 102, 241, 0.1)'
        }], {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#e2e8f0', family: 'Pretendard, sans-serif' },
            xaxis: { showgrid: false },
            yaxis: { showgrid: true, gridcolor: '#334155' },
            margin: { t: 30, b: 40, l: 60, r: 30 },
            height: 350
        }, { responsive: true });
    } else {
        document.getElementById('monthlyChart').innerHTML = '<p class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    }

    function updateReport() {
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        location.href = `/reports?year=${year}&month=${month}`;
    }
</script>
{% endblock %}