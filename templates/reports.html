{% extends "base.html" %}
{% block title %}ë¶„ì„ ë¦¬í¬íŠ¸ - ê°€ê³„ë¶€{% endblock %}

{% block content %}
<div class="reports-page">
    <header class="page-header">
        <h1>ğŸ“ˆ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
        <div class="date-nav">
            <select id="yearSelect" onchange="updateReport()">
                {% for y in years %}
                <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}ë…„</option>
                {% endfor %}
            </select>
            <select id="monthSelect" onchange="updateReport()">
                <option value="">ì „ì²´</option>
                {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}ì›”</option>
                {% endfor %}
            </select>
        </div>
    </header>

    <div class="reports-grid">
        <section class="card">
            <h2>ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h2>
            <div id="categoryChart"></div>
            <div class="summary-list">
                {% for s in category_summary %}
                <div class="summary-item">
                    <span class="color-dot" style="background: {{ s.color or '#64748b' }}"></span>
                    <span class="name">{{ s.name or 'ë¯¸ë¶„ë¥˜' }}</span>
                    <span class="count">{{ s.count or 0 }}ê±´</span>
                    <span class="total">â‚©{{ "{:,}".format(s.total or 0) }}</span>
                </div>
                {% else %}
                <p class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                {% endfor %}
            </div>
        </section>

        <section class="card">
            <h2>ì›”ë³„ ì§€ì¶œ ì¶”ì´</h2>
            <div id="monthlyChart"></div>
        </section>

        <section class="card">
            <h2>íƒœê·¸ë³„ ì§€ì¶œ</h2>
            <div id="tagChart"></div>
            <div class="summary-list">
                {% for t in tag_summary %}
                <div class="summary-item">
                    <span class="tag-badge" style="background: {{ t.color }}">#{{ t.name }}</span>
                    <span class="count">{{ t.count }}ê±´</span>
                    <span class="total">â‚©{{ "{:,}".format(t.total or 0) }}</span>
                </div>
                {% else %}
                <p class="empty-msg">íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                {% endfor %}
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const categoryData = {{ category_summary | tojson }};
    const yearlyData = {{ yearly | tojson }};
    const tagData = {{ tag_summary | tojson }};

    // ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸
    if (categoryData.length > 0) {
        Plotly.newPlot('categoryChart', [{
            type: 'bar',
            x: categoryData.map(s => s.name || 'ë¯¸ë¶„ë¥˜'),
            y: categoryData.map(s => s.total || 0),
            marker: {
                color: categoryData.map(s => s.color || '#64748b'),
                borderRadius: 4
            },
            text: categoryData.map(s => 'â‚©' + (s.total || 0).toLocaleString()),
            textposition: 'outside'
        }], {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#e2e8f0', family: 'Pretendard, sans-serif' },
            xaxis: { showgrid: false },
            yaxis: { showgrid: true, gridcolor: '#334155' },
            margin: { t: 30, b: 60, l: 60, r: 30 }
        }, { responsive: true });
    }

    // ì›”ë³„ ì¶”ì´ ì°¨íŠ¸
    if (yearlyData.length > 0) {
        const months = yearlyData.map(d => d.month + 'ì›”');
        const totals = yearlyData.map(d => d.total || 0);

        Plotly.newPlot('monthlyChart', [{
            type: 'scatter',
            mode: 'lines+markers',
            x: months,
            y: totals,
            line: { color: '#6366f1', width: 3, shape: 'spline' },
            marker: { size: 8, color: '#6366f1' },
            fill: 'tozeroy',
            fillcolor: 'rgba(99, 102, 241, 0.1)'
        }], {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#e2e8f0', family: 'Pretendard, sans-serif' },
            xaxis: { showgrid: false },
            yaxis: { showgrid: true, gridcolor: '#334155' },
            margin: { t: 30, b: 40, l: 60, r: 30 }
        }, { responsive: true });
    } else {
        document.getElementById('monthlyChart').innerHTML = '<p class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    }

    // íƒœê·¸ ì°¨íŠ¸
    if (tagData.length > 0) {
        Plotly.newPlot('tagChart', [{
            type: 'pie',
            labels: tagData.map(t => '#' + t.name),
            values: tagData.map(t => t.total || 0),
            marker: { colors: tagData.map(t => t.color) },
            textinfo: 'label+percent',
            hole: 0.5
        }], {
            paper_bgcolor: 'transparent',
            font: { color: '#e2e8f0', family: 'Pretendard, sans-serif' },
            showlegend: false,
            margin: { t: 20, b: 20, l: 20, r: 20 }
        }, { responsive: true });
    }

    function updateReport() {
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        let url = `/reports?year=${year}`;
        if (month) url += `&month=${month}`;
        location.href = url;
    }
</script>
{% endblock %}